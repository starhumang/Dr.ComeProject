<?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.drcome.project.mem.mapper.UserMemberMapper">
	
	<!-- 사용자 조회 - 시큐리티용 -->
	<select id="getMember" resultType="MemVo">
		SELECT user_id
			 , user_pw
			 , user_name
			 , 'ROLE_' || grade as grade
			 , user_status
		FROM user_login_view
		WHERE user_id = #{id}
	</select>
	
	<!-- 일반 사용자 조회 - 마이페이지용 -->
	<select id="selectMem" resultType="UserMemberVO">
		SELECT user_id
			 , user_name
			 , phone
			 , birthday
			 , gender
			 , identification
		FROM usertable
		WHERE user_id =	#{id}
	</select>
	
	<!-- 일반 사용자 회원 가입 -->
	<insert id="insertUserMember"
		parameterType="UserMemberVO">
        INSERT INTO usertable (user_id
        					, user_pw
        					, user_name
        					, phone
        					, birthday
        					, gender
        					, identification)
        VALUES (#{userId}
        		, #{userPw}
        		, #{userName}
        		, #{phone}
        		, #{birthday}
        		, #{gender}
        		, #{identification})
	</insert>
	
	<!-- 병원 사용자 회원 가입 -->
	<insert id="insertHosMember"
		parameterType="HospitalVO">
        INSERT INTO hospital (hospital_id
        					, hospital_pw
        					, hospital_name
        					, address
        					, phone
        					, hospital_img
        					, main_subject
        					, director_name
        					, director_phone
        					, director_license
        					, holiday
        					, opentime
        					, closetime)
        VALUES (#{hospitalId}
        		, #{hospitalPw}
        		, #{hospitalName}
        		, #{address}
        		, #{phone}
        		, #{hospitalImg}
        		, #{mainSubject}
        		, #{directorName}
        		, #{directorPhone}
        		, #{directorLicense}
        		, #{holiday}
        		, #{opentime}
        		, #{closetime})
	</insert>
	
	<!-- 약국 사용자 회원 가입 -->
	<insert id="insertPamMember"
		parameterType="PharmacyVO">
        INSERT INTO pharmacy (pharmacy_id
        					, pharmacy_pw
        					, pharmacy_name
        					, address
        					, pharmacy_phone
        					, pharmacy_fax
        					, pharmacy_img
        					, ceo_name
        					, ceo_phone
        					, ceo_license
        					, holiday
        					, opentime
        					, closetime)
        VALUES (#{pharmacyId}
        		, #{pharmacyPw}
        		, #{pharmacyName}
        		, #{address}
        		, #{pharmacyPhone}
        		, #{pharmacyFax}
        		, #{pharmacyImg}
        		, #{ceoName}
        		, #{ceoPhone}
        		, #{ceoLicense}
        		, #{holiday}
        		, #{opentime}
        		, #{closetime})
	</insert>
	
	<!-- 아이디 중복 체크 -->
	<select id="checkId" resultType="int" parameterType="String">
		SELECT COUNT(user_id)
		FROM user_login_view
		WHERE user_id = #{id}
	</select>
	
	<!-- 전화번호 중복 체크 -->
	<select id="checkPhone" resultType="int" parameterType="String">
		SELECT COUNT(phone)
		FROM user_login_view
		WHERE phone = #{phone}
	</select>

	<!-- 아이디 찾기 -->
	<select id="findId" resultType="String" parameterType="String">
		SELECT user_id
		FROM user_detail_view
		WHERE user_name = #{userName}
		AND phone =	#{phone}
	</select>
	
	<!-- 비밀번호 찾기 - 변경 -->
	<update id="updatePw" parameterType="MemVO">
		<choose>
			<when test="grade == 'ROLE_USER' or grade == 'ROLE_ADMIN'">
				UPDATE usertable
				SET user_pw = #{userPw}
				WHERE user_id = #{userId}
			</when>
			<when test="grade == 'ROLE_HOSPITAL'">
				UPDATE hospital
				SET hospital_pw = #{userPw}
				WHERE hospital_id = #{userId}
			</when>
			<when test="grade == 'ROLE_PHARMACY'">
				UPDATE pharmacy
				SET pharmacy_pw = #{userPw}
				WHERE pharmacy_id = #{userId}
			</when>
		</choose>
	</update>
	
	<!-- 일반 사용자 정보 변경 -->
	<update id="updateUserInfo" parameterType="MemVO">
		UPDATE usertable
		SET  user_pw = #{userPw}
			,phone = #{phone}
		WHERE user_id = #{userId}
	</update>
	
	<!-- 병원 사용자 정보 변경 -->
	<update id="updateHosInfo" parameterType="HospitalVO">
		UPDATE hospital
		SET hospital_pw = #{hospitalPw}
		  , phone = #{phone}
		  , hospital_img = #{hospitalImg}
		  , director_phone = #{directorPhone}
		  , holiday = #{holiday}
		  , opentime = #{opentime}
		  , closetime = #{closetime}
		WHERE hospital_id = #{hospitalId}
	</update>
	
	<!-- 약국 사용자 정보 변경 -->
	<update id="updatePamInfo" parameterType="PharmacyVO">
		UPDATE pharmacy
		SET pharmacy_pw = #{pharmacyPw}
		  , pharmacy_phone = #{pharmacyPhone}
		  , pharmacy_fax = #{pharmacyFax}
		  , pharmacy_img = #{pharmacyImg}
		  , ceo_phone = #{ceoPhone}
		  , holiday = #{holiday}
		  , opentime = #{opentime}
		  , closetime = #{closetime}
		WHERE pharmacy_id = #{pharmacyId}
	</update>
		
	<!-- 회원 탈퇴 -->
	<update id="deleteUser" parameterType="MemVO">
		<choose>
			<when test="grade == 'ROLE_USER' or grade == 'ROLE_ADMIN'">
				UPDATE usertable
				SET user_status = 'a3'
				WHERE user_id = #{userId}
			</when>
			<when test="grade == 'ROLE_HOSPITAL'">
				UPDATE hospital
				SET user_status = 'a3'
				WHERE hospital_id = #{userId}
			</when>
			<when test="grade == 'ROLE_PHARMACY'">
				UPDATE pharmacy
				SET user_status = 'a3'
				WHERE pharmacy_id = #{userId}
			</when>
		</choose>
	</update>
	
	<!-- 예약 조회 -->
	<select id="selectReserveInfo" resultType="ReservationVO">
		SELECT reserve_no
		     , reserve_year
		     , reserve_month
		     , reserve_day
		     , reserve_time
		     , booking_date
		     , symptom
		     , doctor_no
		     , reserve_kindstatus
		     , reserve_status
		     , user_id
		     , hospital_id
		FROM reservation
		WHERE reserve_no = #{reserveNo}		
	</select>
	
	<!-- 결제 -->
	<insert id="insertPayment" parameterType="PaymentVO">
		INSERT INTO payment (order_num
							, amount
							, user_id)
		VALUES (#{orderNum}
				, #{amount}
				, #{userId}) 
	</insert>

</mapper>